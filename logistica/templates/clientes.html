{% extends "base.html" %}

<!-- 
    VISTA DE LISTADO DE CLIENTES
    Permite:
    - Visualizar la lista de clientes registrados.
    - Filtrar clientes por nombre o RUT (v√≠a JS).
    - Acceder a la creaci√≥n, edici√≥n y eliminaci√≥n de clientes.
    - Carga de datos as√≠ncrona desde la API REST.
-->

{% block content %}

<h2 class="mb-4 d-flex justify-content-between align-items-center">
    <span>Clientes</span>
    <a href="{% url 'clientes_crear' %}" class="btn btn-dark">‚ûï Nuevo Cliente</a>
</h2>

<!-- SECCI√ìN DE FILTROS: Formulario para b√∫squeda en tiempo real -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form id="filtroForm" class="row g-3">

            <div class="col-md-4">
                <label class="form-label fw-bold">Nombre o Raz√≥n Social</label>
                <input id="filtroNombre" type="text" class="form-control" placeholder="Ej: Transportes Ruiz LTDA">
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">RUT</label>
                <input id="filtroRut" type="text" class="form-control" placeholder="Ej: 12.345.678-9">
            </div>

            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary w-100" type="submit">üîç Buscar</button>
            </div>

        </form>
    </div>
</div>

<!-- TABLA DE RESULTADOS: Contenedor donde se inyectan los datos v√≠a JS -->
<div class="card shadow-sm">
    <div class="card-body">

        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>RUT</th>
                    <th>Correo</th>
                    <th>Estado</th>
                    <th class="text-end"></th>
                </tr>
            </thead>

            <tbody id="tablaClientes">
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        Cargando clientes...
                    </td>
                </tr>
            </tbody>

        </table>

    </div>
</div>

<script>
// ===============================
// L√ìGICA DE CLIENTE (Frontend)
// ===============================

// Funci√≥n para cargar la tabla de clientes desde la API
async function cargarClientes() {
    const tbody = document.getElementById("tablaClientes");
    tbody.innerHTML = `
        <tr><td colspan="5" class="text-center text-muted py-4">Cargando...</td></tr>
    `;

    try {
        // Petici√≥n GET a la API
        const res = await fetch("http://127.0.0.1:8000/clientes/");
        const data = await res.json();

        if (data.length === 0) {
            tbody.innerHTML = `
                <tr><td colspan="5" class="text-center text-muted py-4">
                    <div class="fs-5">No hay clientes registrados.</div>
                    <div>Agrega un cliente para comenzar.</div>
                </td></tr>
            `;
            return;
        }

        // Renderizado de filas
        tbody.innerHTML = "";
        data.forEach(c => {
            tbody.innerHTML += `
                <tr>
                    <td>üë§ <strong>${c.nombre}</strong></td>
                    <td>${c.rut}</td>
                    <td>${c.correo ? "‚úâÔ∏è " + c.correo : "<span class='text-muted'>Sin correo</span>"}</td>
                    <td>
                        ${c.activo
                            ? "<span class='badge bg-success'>Activo</span>"
                            : "<span class='badge bg-danger'>Inactivo</span>"
                        }
                    </td>
                    <td class="text-end">
                        <a href="/site/clientes/editar/${c.id}/" class="btn btn-outline-dark btn-sm">
                            Editar ‚Üí
                        </a>
                    </td>
                </tr>
            `;
        });

    } catch (error) {
        console.error("Error cargando clientes:", error);
        tbody.innerHTML = `
            <tr><td colspan="5" class="text-center text-danger py-4">
                Error al cargar datos. Aseg√∫rate de que la API est√© corriendo.
            </td></tr>
        `;
    }
}

// Evento de b√∫squeda (Filtros)
document.getElementById("filtroForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nombre = document.getElementById("filtroNombre").value;
    const rut = document.getElementById("filtroRut").value;

    // Construcci√≥n de URL con par√°metros de b√∫squeda
    let url = "http://127.0.0.1:8000/clientes/?";
    if (nombre) url += `search=${nombre}&`;
    if (rut) url += `rut=${rut}`;

    // Reutilizamos la l√≥gica de renderizado (simplificada aqu√≠ para el ejemplo)
    // En una implementaci√≥n real, refactorizar√≠amos cargarClientes para aceptar URL
    const tbody = document.getElementById("tablaClientes");
    tbody.innerHTML = `
        <tr><td colspan="5" class="text-center text-muted py-4">Cargando...</td></tr>
    `;

    try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.length === 0) {
            tbody.innerHTML = `
                <tr><td colspan="5" class="text-center text-muted py-4">
                    No se encontraron coincidencias.
                </td></tr>
            `;
            return;
        }

        tbody.innerHTML = "";
        data.forEach(c => {
            tbody.innerHTML += `
                <tr>
                    <td>üë§ <strong>${c.nombre}</strong></td>
                    <td>${c.rut}</td>
                    <td>${c.correo ? "‚úâÔ∏è " + c.correo : "<span class='text-muted'>Sin correo</span>"}</td>
                    <td>
                        ${c.activo
                            ? "<span class='badge bg-success'>Activo</span>"
                            : "<span class='badge bg-danger'>Inactivo</span>"
                        }
                    </td>
                    <td class="text-end">
                        <a href="/site/clientes/editar/${c.id}/" class="btn btn-outline-dark btn-sm">
                            Editar ‚Üí
                        </a>
                    </td>
                </tr>
            `;
        });

    } catch (error) {
        console.error("Error aplicando filtros:", error);
        tbody.innerHTML = `
            <tr><td colspan="5" class="text-center text-danger py-4">
                Error al aplicar filtros. Int√©ntalo nuevamente.
            </td></tr>
        `;
    }
});

// Cargar al inicio
cargarClientes();
</script>

{% endblock %}
