{% extends "base.html" %}

<!-- 
    VISTA DE LISTADO DE VEH√çCULOS
    Permite:
    - Visualizar la flota de veh√≠culos terrestres.
    - Filtrar por patente y marca.
    - Acceder a la creaci√≥n y edici√≥n de veh√≠culos.
    - Carga as√≠ncrona de datos.
-->

{% block content %}

<h2 class="mb-4 d-flex justify-content-between align-items-center">
    <span>Veh√≠culos</span>
    <a href="{% url 'vehiculos_crear' %}" class="btn btn-dark">‚ûï Nuevo Veh√≠culo</a>
</h2>

<!-- SECCI√ìN DE FILTROS: B√∫squeda por patente y marca -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form id="filtroForm" class="row g-3">

            <div class="col-md-4">
                <label class="form-label fw-bold">Patente</label>
                <input id="filtroPatente" type="text" class="form-control" placeholder="Ej: ABCD-12">
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Marca</label>
                <input id="filtroMarca" type="text" class="form-control" placeholder="Ej: Mercedes">
            </div>

            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary w-100" type="submit">üîç Buscar</button>
            </div>

        </form>
    </div>
</div>

<!-- TABLA DE RESULTADOS: Listado de veh√≠culos -->
<div class="card shadow-sm">
    <div class="card-body">

        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Patente</th>
                    <th>Marca / Modelo</th>
                    <th>Capacidad</th>
                    <th>Tipo</th>
                    <th class="text-end"></th>
                </tr>
            </thead>

            <tbody id="tablaVehiculos">
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        Cargando veh√≠culos...
                    </td>
                </tr>
            </tbody>

        </table>

    </div>
</div>

<script>
// ===============================
// L√ìGICA DE VEH√çCULOS (Frontend)
// ===============================

// Funci√≥n para cargar la tabla de veh√≠culos desde la API
async function cargarVehiculos() {
    const tbody = document.getElementById("tablaVehiculos");
    tbody.innerHTML = `
        <tr><td colspan="5" class="text-center text-muted py-4">Cargando...</td></tr>
    `;

    try {
        // Petici√≥n GET a la API
        const res = await fetch("http://127.0.0.1:8000/vehiculos/");
        const data = await res.json();

        if (data.length === 0) {
            tbody.innerHTML = `
                <tr><td colspan="5" class="text-center text-muted py-4">
                    <div class="fs-5">No hay veh√≠culos registrados.</div>
                    <div>Agrega un veh√≠culo para comenzar.</div>
                </td></tr>
            `;
            return;
        }

        // Renderizado de filas
        tbody.innerHTML = "";
        data.forEach(v => {
            tbody.innerHTML += `
                <tr>
                    <td>üöõ <strong>${v.patente}</strong></td>
                    <td>${v.marca} ${v.modelo}</td>
                    <td>${v.capacidad_kg} kg</td>
                    <td><span class="badge bg-info text-dark">${v.tipo_transporte}</span></td>
                    <td class="text-end">
                        <a href="/site/vehiculos/editar/${v.id}/" class="btn btn-outline-dark btn-sm">
                            Editar ‚Üí
                        </a>
                    </td>
                </tr>
            `;
        });

    } catch (error) {
        tbody.innerHTML = `
            <tr><td colspan="5" class="text-center py-4 text-danger">
                Error al cargar veh√≠culos
            </td></tr>
        `;
        console.error(error);
    }
}

// ===============================
// Filtros (client-side)
// ===============================

document.getElementById("filtroForm").addEventListener("submit", e => {
    e.preventDefault();
    aplicarFiltros();
});

async function aplicarFiltros() {
    const patente = document.getElementById("filtroPatente").value.toLowerCase();
    const marca = document.getElementById("filtroMarca").value.toLowerCase();

    const res = await fetch("http://127.0.0.1:8000/vehiculos/");
    const data = await res.json();

    const filtrados = data.filter(v =>
        v.patente.toLowerCase().includes(patente) &&
        v.marca.toLowerCase().includes(marca)
    );

    const tbody = document.getElementById("tablaVehiculos");
    tbody.innerHTML = "";

    if (filtrados.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="5" class="text-center text-muted py-4">
                No se encontraron coincidencias.
            </td></tr>
        `;
        return;
    }

    filtrados.forEach(v => {
        tbody.innerHTML += `
            <tr>
                <td>üöõ <strong>${v.patente}</strong></td>
                <td>${v.marca} ${v.modelo}</td>
                <td>${v.capacidad_kg} kg</td>
                <td><span class="badge bg-info text-dark">${v.tipo_transporte}</span></td>
                <td class="text-end">
                    <a href="/site/vehiculos/editar/${v.id}/" class="btn btn-outline-dark btn-sm">
                        Editar ‚Üí
                    </a>
                </td>
            </tr>
        `;
    });
}

// Cargar al inicio
cargarVehiculos();
</script>

{% endblock %}
